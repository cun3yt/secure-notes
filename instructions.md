# Project Overview

You are building a secure note taking application. The security will be via end to end encryption with cryptography.
The application will be only for the user himself, no sharing ability. So the encryption key will be only for the user.
However, different encryption keys will be used for different document groupings. These groupings will be identified per
key. The words "user" and "session" will be used interchangeably in this document. Both the user and the session refers
to grouping of documents. And an associated encryption key will be used to encrypt and decrypt the documents.

# User and Session Management

Each session will be identified with a cryptograhic key. The key will be generated for the user on the frontend side.
However, there will be an address generated by the key. The address will be used as a session identifier. The address
will be used to associate the documents with the session.

# Document Management

The end user of the application will be able to generate his cryptographic key.
The key will require passphrase. The interface will be provided on the web. It will
be responsive for best view and edit ability on mobile web browser, e.g. Safari.

# Core functionalities

## 1. The main screen:

1. The URL of the main screen is just the `<base-url>` when the user first opens the application. It is the case when there is no active session.
2. The main screen will provide two abilities with two buttons:
   1. Start a new session:
      1. Once the button is clicked, it will generate a new key and a passphrase.
      2. The key will be generated and stored in the browser's local storage. The key will be shown to be copied to the clipboard. The user will provide a passphrase to the key.
   2. Load a previous session: The user will provide the key and the passphrase.

## 2. Sessions screen: Each session is identified with the address that is generated from the key.

1.  URL: The URL will be the address of the session: `<base-url>/s/<session-address>`. The address is derived from the key.
2.  If the session is not loaded, session URL will redirect to the main screen: `<base-url>`.
3.  The session screen will have the following components:
    1.  End Session Button: The user will be able to end the session by clicking the "End Session" button. Refer to the "Ending a session from the sessions screen" section for the details.
    2.  Add new document button: The user will be able to add a new document by clicking the "New" button. Refer to the "New Document" section for the details.
    3.  The list of documents from that session. With pagination of 10 documents per page. Each list item will have a title, a creation date, and a last modified date. The list will be sorted by the last modified date. The item will be clickable to navigate to the document screen.
    4.  Page buttons at the bottom of the screen.
4.  New Session: When a new session is created, the key will be generated and stored in the browser's local storage. The key will be shown to be copied to the clipboard. The user will provide a passphrase to the key.
5.  Load Session: The interface will have a field for the key, a field for the passphrase, and a submit button. Once the button is clicked, the key and the passphrase will be verified. If they are correct, the session will be loaded. If not, an error message will be shown as "Invalid key and/or passphrase".

## 3. Document screen:

1.  URL: The URL will be the address of the document: `<base-url>/s/<session-address>/d/<document-id>`. The document URL is derived from the document's content.
2.  The document screen will have these components:
    1.  The title of the document
    2.  Save button: Active when there are changes in the document. Otherwise, it will be inactive.
    3.  Delete button: Active when there are changes in the document. Otherwise, it will be inactive. If it is clicked, it will ask for confirmation first. Once confirmed, the document will be deleted from the backend API server. And the user will be redirected to the session screen.
3.  Title: The first line of the document will be used as the title of the document.
4.  Save button: The save button will save the document in encrypted form to the backend API server.
5.  Delete button: The delete button will delete the document from the backend API server.
6.  Return button: The return button will return the user to the session screen. If there is any changes in the document, the user will be asked to save the changes before returning to the session screen.
7.  If the session is ended, the user will be redirected to the main screen: `<base-url>`.

## 3. Ending a session from the sessions screen:

1.  The user will end the session by clicking the "End Session" button.
2.  The session can also be automatically ended after 12 hours. This means that the screen will be reseted to the main screen after ending a session or automatically after 12 hours of the session start.
3.  The session will be automatically ended when the browser is closed.
4.  If the session is ended manually, the key and the passphrase will be deleted from the browser's local storage.
5.  If the session is ended automatically, the key and the passphrase will be deleted from the browser's local storage on the next page load.
6.  Once the session is ended, the user will be redirected to the main screen: `<base-url>`.

## 4. Relationships:

1.  Each session will have one or more documents.

## 5. Document Relationship: Once a new session is created, the user will be able to create a new document by clicking "New" button.

1.  Document URL: A new document or an existing document will have its own URL. Each url will be long enough not to be guess or brute-forced.
2.  Document Screen: The document screen will have a save button, and discard button on the top.
    1. Save button: The save button will save the document in encrypted form to the backend API server.
    2. Discard button: The discard button will discard the changes in the current document.
3.  Document Title:
    1. The first line of the document will be used as the title of the document.
    2. There will be no other title entry area on the document screen.

## 6. New Document: The user will be able to create a new document by clicking "New" button

1.  New document will generate a new URL.
2.  New document will be encrypted with a random key.
3.  The key will be stored in the browser's local storage.
4.  The user will be able to copy the URL and share it with others.
5.  The user will be able to edit the document by clicking "Edit" button.

## 7. The backend API will save the document content in encrypted form. The key and the passphrase will never to be sent or stored in the backend API.

## 8. Use the latest technologies for development as much as possible.

## 9. Use icons from Lucid icon for the frontend. Use them especially for the buttons.

# Development & Technologies

You will be using the following technologies:

1. Backend:
   1. Python 3: The latest version.
   2. Flask: API server.
   3. Posgres: The database. Use docker to run the database.
   4. Marshmallow: For object serialization and validation.
   5. SQLAlchemy: For database ORM.
   6. Flask-SQLAlchemy: For database integration with Flask.
   7. gunicorn: For production server.
   8. Pyenv: For Python version management.
   9. Pip: For Python package management.
   10. Pytest: For testing.
2. Frontend:
   1. Typescript as the programming language.
   2. NextJS as the framework.
   3. Shadcn as the component library.
   4. Tailwind as the CSS framework.
   5. Lucid icon as the icon library.
   6. Encryption: Web Crypto API (Native) for encryption on the frontend side.

The development will be done in the local machine. The backend API will be hosted on http://localhost:5000. The frontend
will be hosted on http://localhost:3000.

## Deployment

The deployment will be done in the cloud. The details will be provided later.

# Current file structure

This will be updated as the development progresses. The current file structure can be found in the repository.

# Sample Code

Refer to the following files for the sample code:

1. javascript code to encrypt and decrypt a document: sample-crypto-javascript.md
2. backend database model: sample-database-model.md
